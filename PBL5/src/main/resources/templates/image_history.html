<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Lịch sử chụp ảnh</title>
<!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"-->
<!--          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">-->
    <link href="../static/bootstrap-5.0.2-dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="../static/bootstrap-5.0.2-dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous">
    </script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script th:src="@{/js/imagetodata.js}"></script>
    <script src="./js/imagetodata.js"></script>
</head>
<body>
<div class="row">
    <div class="col-1"></div>
    <div class="col-10">
        <h1>Lịch sử chụp ảnh</h1>
        <img id="imageInput1" width="100px"
             src="https://png.pngtree.com/png-clipart/20230413/original/pngtree-puppy-cartoon-happy-little-black-dog-png-image_9051799.png"
             alt="Image">
        <!--        <a th:href="@{/image/capture}">-->
        <a>
            <button class="btn btn-primary" id="captureBtn" onclick="captureImage()" data-bs-toggle="modal"
                    data-bs-dismiss="modal"
                    data-bs-target="#loadingModal">
                Chụp ảnh
            </button>
        </a>
        <p class="text-danger" id="mess" th:text="${mess}"></p>
        <table class="table table-striped">
            <tr>
                <th>STT</th>
                <th>Ảnh</th>
                <th>Thời gian chụp</th>
                <th>Số lượng</th>
                <th>Lựa chọn</th>
            </tr>
            <th:block th:each="history, row: ${historyList}">
                <tr>
                    <td th:text="${row.count}"></td>
                    <td>
                        <img th:src="'data:image/png;base64,' + ${history.getImage()}" alt="Cover" height="80"
                             width="200">
                    </td>
                    <td th:text="${history.getTime()}"></td>
                    <td th:text="${history.getAmount()}"></td>
                    <td>
                        <button type="button" class="btn btn-danger" data-bs-toggle="modal"
                                data-bs-target="#deleteModal"
                                th:attr="onclick=|deleteItem('${history.getId()}')|">Xoá
                        </button>
                        <label>
                            <input name="idDelete" class="form-check-input" type="checkbox"
                                   th:value="${history.getId()}">
                        </label>
                    </td>
                </tr>
                <tr th:if="${historyList.isEmpty()}">
                    <td colspan="5" class="text-center">Danh sách trống.</td>
                </tr>
            </th:block>
        </table>
        <button id="btn" type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                data-bs-toggle="modal" data-bs-target="#deleteModals">Xoá nhiều
        </button>
    </div>
    <div class="col-1"></div>
</div>
<!--Modal delete-->
<div class="modal fade" id="deleteModal" data-bs-backdrop="static" data-bs-keyboard="false"
     tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabel">Xoá</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Bạn có muốn xoá ảnh này không?
            </div>
            <form action="/images/delete" method="get">
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng
                    </button>
                    <button type="submit" class="btn btn-danger">Xoá</button>
                    <input hidden name="id" type="text" id="idDelete">
                    <input hidden name="action" value="delete" type="text" id="">
                </div>
            </form>
        </div>
    </div>
</div>
<!--Modal delete nhiều-->
<div class="modal fade" id="deleteModals" data-bs-backdrop="static" data-bs-keyboard="false"
     tabindex="-1" aria-labelledby="staticBackdropLabel1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabel1">Đang chụp ảnh</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Bạn có muốn xoá những hàng đã chọn không?
            </div>
            <form action="/images/multiDelete" method="get">
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng
                    </button>
                    <button type="submit" class="btn btn-danger">Xoá</button>
                    <input hidden type="text" id="idDeleteMore" name="idDeleteMore">
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Modal thông báo đang tải -->
<div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false"
     tabindex="-1" aria-labelledby="staticBackdropLabel2" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabel2">Gửi yêu cầu chụp ảnh</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="closeModal('loadingModal')"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Đang tải...
            </div>
            <div class="modal-footer">
                <!--                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>-->
            </div>
        </div>
    </div>
</div>

<!-- Modal thông báo thành công -->
<div class="modal fade" id="successModal" data-bs-backdrop="false" data-bs-keyboard="false"
     tabindex="-1" aria-labelledby="staticBackdropLabel3" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabel3">Chụp ảnh thành công</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Thành công!
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="location.reload()">
                    Đóng
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Modal thông báo thất bại -->
<div class="modal fade" id="failedModal" data-bs-backdrop="false" data-bs-keyboard="false"
     tabindex="-1" aria-labelledby="staticBackdropLabel4" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabel4">Chụp ảnh thất bại</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Đã có lỗi xảy ra!
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>
</body>
<script>
    document.getElementById('btn').onclick = function () {
        let checkbox = document.getElementsByName('idDelete');
        let result = "";
        for (let i = 0; i < checkbox.length; i++) {
            if (checkbox[i].checked === true) {
                result += '.' + checkbox[i].value;
            }
        }
        document.getElementById('idDeleteMore').value = result;
    };

    function deleteItem(id) {
        document.getElementById('idDelete').value = id;
    }
</script>
<script>
    let request;
    let loadingModalVisible = false; // Biến để theo dõi trạng thái của modal loading
    console.log(loadingModalVisible);

    function captureImage() {
        let loadingModal = document.getElementById("loadingModal");
        var bootstrapLoadingModal = new bootstrap.Modal(loadingModal);

        loadingModalVisible = true; // Đánh dấu modal loading đã hiển thị
        console.log(loadingModalVisible);

        request = new XMLHttpRequest();
        let URL = "http://172.20.10.2";
        request.open("GET", URL + "/takepicture", true);
        request.onload = function () {
            if (request.status === 200) {
                console.log(request.responseText);
                // closeModal("loadingModal");
                // openModal("successModal");

            } else {
                closeModal("loadingModal");
                openModal("failedModal");
                console.log("Request failed. Status: " + request.status);
            }
        };
        request.onerror = function () {
            // closeModal("loadingModal");
            // openModal("failedModal");
            console.log("An error occurred while sending the request.");
            let image = document.getElementById("imageInput");
            saveImage(image);
        };
        request.send();
    }

    // Hàm để mở modal
    function openModal(modalId) {
        let modal = document.getElementById(modalId);
        let bootstrapModal = new bootstrap.Modal(modal, {
            backdrop: 'static', // Tạo nền tối xung quanh modal
            keyboard: false, // Không cho phép tắt modal bằng phím ESC
            mouse: false
        });
        bootstrapModal.show();
    }

    // Hàm để đóng modal
    function closeModal(modalId) {
        let modal = document.getElementById(modalId);
        let bootstrapModal = new bootstrap.Modal(modal);
        if (modalId === "loadingModal" && loadingModalVisible && request && request.readyState !== XMLHttpRequest.DONE) {
            request.abort();
            bootstrapModal.hide();
            loadingModalVisible = false;
            console.log("Đã hủy request.");
            console.log(loadingModalVisible);

        } else {
            bootstrapModal._hideModal();
            removeModalBackdrop();
        }
    }

    function removeModalBackdrop() {
        let modalBackdrop = document.querySelector(".modal-backdrop.fade.show");
        if (modalBackdrop) {
            modalBackdrop.remove();
        }
    }
</script>
</html>